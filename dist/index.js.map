{"version":3,"sources":["../src/index.js"],"names":["fs","require","chalk","request","module","exports","config","compiler","afterEmit","compilation","callback","validateConfig","deployHandler","hooks","tapAsync","plugin","receiver","token","mapping","error","type","Object","prototype","toString","call","assets","avalAssets","map","item","index","key","asset","assetPath","existsAt","from","startsWith","push","avalKeys","keys","length","formData","dest","replace","deploy","file","createReadStream","post","url","err","statusCode","body","time","Date","toLocaleTimeString","console","log","green","yellow","process","exit"],"mappings":"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","file":"index.js","sourcesContent":["const fs = require('fs');\r\nconst chalk = require('chalk');\r\nconst request = require('request');\r\n\r\nmodule.exports = class DeployServerWebpackPlugin {\r\n\tconstructor(config = {}) {\r\n\t\tthis.config = config;\r\n\t}\r\n\r\n\tapply(compiler) {\r\n\t\tlet afterEmit = (compilation, callback) => {\r\n\t\t\tthis.validateConfig(compilation);\r\n\t\t\tthis.deployHandler(callback);\r\n\t\t}\r\n\r\n\t\tif (compiler.hooks) {\r\n\t\t\tcompiler.hooks.afterEmit.tapAsync('afterEmit', afterEmit);\r\n\t\t} else {\r\n\t\t\tcompiler.plugin('after-emit', afterEmit);\r\n\t\t}\r\n\t}\r\n\r\n\tvalidateConfig(compilation) {\r\n\t\tconst { receiver, token = '' } = this.config;\r\n\t\tlet { mapping } = this.config;\r\n\r\n\t\tif (!receiver) {\r\n\t\t\tthis.error('Missing param: receiver');\r\n\t\t}\r\n\t\tif (!mapping) {\r\n\t\t\tthis.error('Missing param: mapping');\r\n\t\t}\r\n\r\n\t\tconst type = Object.prototype.toString.call(mapping);\r\n\t\tif (type === '[object Object]') {\r\n\t\t\tmapping = [mapping];\r\n\t\t} else if (type === '[object Array]') {\r\n\t\t\t// do nothing\r\n\t\t} else {\r\n\t\t\tthis.error('Invalid param: mapping');\r\n\t\t}\r\n\r\n\t\tconst assets = compilation.assets;\r\n\t\tconst avalAssets = {};\r\n\t\tmapping.map((item, index) => {\r\n\t\t\tfor (let key in assets) {\r\n\t\t\t\tconst asset = assets[key];\r\n\t\t\t\tconst assetPath = asset.existsAt;\r\n\t\t\t\tconst from = item.from;\r\n\t\t\t\t// limit \"src\" path within compiled files\r\n\t\t\t\tif (assetPath.startsWith(from)) {\r\n\t\t\t\t\tif (!avalAssets[from]) {\r\n\t\t\t\t\t\tavalAssets[from] = [assetPath];\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tavalAssets[from].push(assetPath);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tconst avalKeys = Object.keys(avalAssets);\r\n\t\tif (!avalKeys.length) {\r\n\t\t\tthis.error('No available mapping files');\r\n\t\t}\r\n\r\n\t\tthis.receiver = receiver;\r\n\t\tthis.mapping = mapping;\r\n\t\tthis.token = token;\r\n\t\tthis.avalKeys = avalKeys;\r\n\t\tthis.avalAssets = avalAssets;\r\n\t}\r\n\r\n\tdeployHandler(callback) {\r\n\t\tconst formData = {};\r\n\t\tthis.avalKeys.map((item, index) => {\r\n\t\t\tthis.avalAssets[item].map(from => {\r\n\t\t\t\t// compatible with windows\r\n\t\t\t\tconst dest = (this.mapping[index].dest + from.replace(item, '')).replace(/\\\\/g, '/');\r\n\t\t\t\tthis.deploy({\r\n\t\t\t\t\tfile: fs.createReadStream(from),\r\n\t\t\t\t\tdest,\r\n\t\t\t\t\ttoken: this.token\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tcallback();\r\n\t}\r\n\r\n\tdeploy(formData) {\r\n\t\trequest.post({\r\n\t\t\turl: this.receiver,\r\n\t\t\tformData\r\n\t\t}, (err, { statusCode } = {}, body) => {\r\n\t\t\tconst time = new Date().toLocaleTimeString();\r\n\t\t\tif (!err && statusCode === 200) {\r\n\t\t\t\tconsole.log(chalk.green(`[${time}] [success] => ${formData.dest}`));\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconsole.log(chalk.yellow(`[${time}] [failed] => ${formData.dest} ${body}`));\r\n\t\t});\r\n\t}\r\n\r\n\terror(err) {\r\n\t\tconsole.log(`\\n${chalk.yellow('[deploy-server-webpack-plugin] ' + err + '. Deploy interrupted.')}`);\r\n\t\tprocess.exit();\r\n\t}\r\n};\r\n"]}