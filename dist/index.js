'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var fs=require('fs');var path=require('path');var chalk=require('chalk');var request=require('request');module.exports=function(){function DeployServerWebpackPlugin(){var config=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};_classCallCheck(this,DeployServerWebpackPlugin);this.config=config;}_createClass(DeployServerWebpackPlugin,[{key:'apply',value:function apply(compiler){var _this=this;compiler.plugin('after-emit',function(compilation,callback){_this.validConfig(compilation);_this.deployHandler(callback);});}},{key:'validConfig',value:function validConfig(compilation){var _config=this.config,receiver=_config.receiver,_config$token=_config.token,token=_config$token===undefined?'':_config$token;var mapping=this.config.mapping;if(!receiver){this.error('Missing param: receiver');}if(!mapping){this.error('Missing param: mapping');}var mappingType=Object.prototype.toString.call(mapping);if(mappingType==='[object Object]'){mapping=[mapping];}else if(mappingType==='[object Array]'){// do nothing
}else{this.error('Invalid param: mapping');}var assets=compilation.assets;var avalAssets={};mapping.map(function(item,index){for(var key in assets){var asset=assets[key];var assetPath=asset.existsAt;var from=item.from;// limit "src" path within compiled files
if(assetPath.startsWith(from)){if(!avalAssets[from]){avalAssets[from]=[assetPath];continue;}avalAssets[from].push(assetPath);}}});var avalKeys=Object.keys(avalAssets);if(!avalKeys.length){this.error('No available mapping files');}this.receiver=receiver;this.mapping=mapping;this.token=token;this.avalKeys=avalKeys;this.avalAssets=avalAssets;}},{key:'deployHandler',value:function deployHandler(callback){var _this2=this;var formData={};this.avalKeys.map(function(item,index){_this2.avalAssets[item].map(function(from){// compatible with windows
var dest=(_this2.mapping[index].to+from.replace(item,'')).replace(/\\/g,'/');_this2.deploy({dest:dest,token:_this2.token,file:fs.createReadStream(from)});});});callback();}},{key:'deploy',value:function deploy(formData){request.post({url:this.receiver,formData:formData},function(err){var _ref=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},statusCode=_ref.statusCode;var body=arguments[2];var time=new Date().toLocaleTimeString();if(!err&&200===statusCode){console.log(chalk.green('['+time+'] [success] => '+formData.dest));return;}console.log(chalk.yellow('['+time+'] [failed] => '+formData.dest+' '+body));});}},{key:'error',value:function error(err){console.log('\n'+chalk.yellow('[deploy-server-webpack-plugin] '+err));process.exit();}}]);return DeployServerWebpackPlugin;}();